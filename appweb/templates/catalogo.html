<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cat√°logo de Turnos - Nails Studio</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='catalogo.css') }}">
</head>
<body>

  <header>
    <h1>Agenda Nails - Cat√°logo de Turnos</h1>
    <button class="volver-inicio" onclick="window.location.href='/'">Volver al inicio</button>
    <a href="{{ url_for('mis_turnos') }}" style="margin-left: 10px;">Mis Turnos</a>
    <a href="{{ url_for('logout') }}" style="margin-left: 10px;">Cerrar Sesi√≥n</a>
  </header>

  <!-- Bot√≥n para entrar al modo administrador (solo si es admin) -->
  {% if session.get('is_admin') %}
  <div class="admin-access">
    <a href="{{ url_for('admin') }}" style="text-decoration: none;">
      <button id="btn-admin">Panel Administrador</button>
    </a>
  </div>
  {% endif %}

  <!-- Secci√≥n visible para el usuario -->
  <section id="usuario">
    <!-- Cat√°logo de servicios -->
    <div class="catalogo" id="catalogo-servicios">
      <!-- Los servicios se cargar√°n din√°micamente desde la base de datos -->
      {% if services %}
        {% for service in services %}
        <div class="card" data-id="{{ service.id }}" data-nombre="{{ service.nombre }}" data-precio="{{ service.precio }}">
          <h3>{{ service.nombre }}</h3>
          <p>{{ service.descripcion }}</p>
          <p>Duraci√≥n: {{ service.duracion }} minutos</p>
          <span class="precio">${{ "{:,.0f}".format(service.precio) }}</span>
          <button class="btn-agregar" data-id="{{ service.id }}" data-nombre="{{ service.nombre }}" data-precio="{{ service.precio }}">Agregar</button>
        </div>
        {% endfor %}
      {% else %}
        <p>No hay servicios disponibles en este momento.</p>
      {% endif %}
    </div>

    <!-- Carrito -->
    <aside class="carrito">
      <h2>Tu selecci√≥n</h2>
      <ul id="lista-carrito"></ul>
      <p id="total">Total: $0</p>

      <input type="date" id="fecha" required>
      <input type="time" id="horario" required>
      <small style="display: block; margin-top: 10px; color: #666;">
        Selecciona fecha y hora para tu turno
      </small>

      <button id="btn-agendar">Agendar turno</button>
      <div class="turno">
        <div class="button-container">
          <a href="{{ url_for('mis_turnos') }}" class="btn cancel">Ver mis turnos</a>
        </div>
      </div>
    </aside>
  </section>

  <!-- Modal de √©xito -->
  <div id="modal" class="modal oculto">
    <div class="modal-contenido">
      <h3>¬°Turno agendado con √©xito!</h3>
      <p>Gracias por elegirnos üíÖ</p>
      <button onclick="cerrarModal()">Cerrar</button>
    </div>
  </div>

  <!-- Modal de error -->
  <div id="modal-error" class="modal oculto">
    <div class="modal-contenido error">
      <h3>Error</h3>
      <p id="mensaje-error"></p>
      <button onclick="cerrarModalError()">Cerrar</button>
    </div>
  </div>

  <script>
    // --- Variables principales ---
    const listaCarrito = document.getElementById('lista-carrito');
    const totalElemento = document.getElementById('total');
    const btnAgendar = document.getElementById('btn-agendar');
    const modal = document.getElementById('modal');
    const modalError = document.getElementById('modal-error');
    const fechaInput = document.getElementById('fecha');
    const horarioInput = document.getElementById('horario');

    let carrito = [];

    // --- Deshabilitar fechas anteriores ---
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    fechaInput.setAttribute('min', hoy.toISOString().split('T')[0]);

    // --- Agregar servicio al carrito ---
    document.querySelectorAll('.btn-agregar').forEach(btn => {
      btn.addEventListener('click', () => {
        const serviceId = parseInt(btn.dataset.id);
        const serviceNombre = btn.dataset.nombre;
        const servicePrecio = parseFloat(btn.dataset.precio);
        
        // Verificar si el servicio ya est√° en el carrito
        const existe = carrito.find(item => item.id === serviceId);
        if (!existe) {
          carrito.push({
            id: serviceId,
            nombre: serviceNombre,
            precio: servicePrecio
          });
          actualizarCarrito();
        } else {
          alert('Este servicio ya est√° en tu carrito');
        }
      });
    });

    function actualizarCarrito() {
      listaCarrito.innerHTML = '';
      let total = 0;
      
      carrito.forEach((item, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          ${item.nombre} - $${item.precio.toLocaleString('es-AR')}
          <button onclick="eliminarDelCarrito(${index})" style="margin-left: 10px; background: red; color: white; border: none; padding: 2px 8px; cursor: pointer;">X</button>
        `;
        listaCarrito.appendChild(li);
        total += item.precio;
      });
      
      totalElemento.textContent = `Total: $${total.toLocaleString('es-AR')}`;
    }

    function eliminarDelCarrito(index) {
      carrito.splice(index, 1);
      actualizarCarrito();
    }

    // --- Agendar turno ---
    btnAgendar.addEventListener('click', async () => {
      const fecha = fechaInput.value;
      const hora = horarioInput.value;

      if (!fecha || !hora) {
        mostrarError('Por favor selecciona fecha y hora');
        return;
      }

      if (carrito.length === 0) {
        mostrarError('Por favor agrega al menos un servicio al carrito');
        return;
      }

      // Validar que la fecha no sea en el pasado
      const fechaSeleccionada = new Date(fecha + 'T' + hora);
      if (fechaSeleccionada < new Date()) {
        mostrarError('No puedes agendar turnos en el pasado');
        return;
      }

      // Preparar datos para enviar
      const datosTurno = {
        servicios: carrito,
        fecha: fecha,
        hora: hora
      };

      try {
        const response = await fetch('/agendar_turno', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(datosTurno)
        });

        const data = await response.json();

        if (data.success) {
          // Limpiar carrito y formulario
          carrito = [];
          actualizarCarrito();
          fechaInput.value = '';
          horarioInput.value = '';
          
          // Mostrar modal de √©xito
          modal.classList.remove('oculto');
          setTimeout(() => {
            cerrarModal();
          }, 3000);
        } else {
          mostrarError(data.message || 'Error al agendar el turno');
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarError('Error de conexi√≥n. Por favor intenta nuevamente.');
      }
    });

    function mostrarError(mensaje) {
      document.getElementById('mensaje-error').textContent = mensaje;
      modalError.classList.remove('oculto');
    }

    function cerrarModal() {
      modal.classList.add('oculto');
    }

    function cerrarModalError() {
      modalError.classList.add('oculto');
    }

    // Generar horarios disponibles (ejemplo: cada hora de 9:00 a 18:00)
    function generarHorarios() {
      const horarios = [];
      for (let h = 9; h <= 18; h++) {
        for (let m = 0; m < 60; m += 30) {
          const hora = String(h).padStart(2, '0');
          const minuto = String(m).padStart(2, '0');
          horarios.push(`${hora}:${minuto}`);
        }
      }
      return horarios;
    }

    // Cargar horarios disponibles en el input time
    // Nota: Los navegadores modernos permiten usar step en input type="time"
    horarioInput.setAttribute('step', '1800'); // 30 minutos
  </script>
</body>
</html>
